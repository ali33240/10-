<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>哆啦A夢數學大冒險</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 引入可愛的圓體字型 */
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
        /* 引入等寬字體，用於數學題目的數字對齊 */
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&display=swap');
        
        /* 定義哆啦A夢主題色變數 */
        :root {
            --dora-blue: #00AEEF;
            --dora-red: #EE4035;
            --dora-yellow: #FAEC32;
            --dora-white: #FFFFFF;
        }

        /* 修正：移除 overflow-hidden，並使用 min-h-[100dvh] 確保內容可以滾動 */
        body {
            font-family: 'Fredoka', sans-serif;
            touch-action: manipulation;
            user-select: none;
            overscroll-behavior: none;
            background: linear-gradient(135deg, #E0F7FF 0%, #B3E5FC 100%);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 174, 239, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(250, 236, 50, 0.2) 0%, transparent 20%);
            background-attachment: fixed;
        }
        
        /* === 題目對齊樣式 (文字加大) === */
        .math-column {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            font-size: 10rem; /* 加大題目數字字體 */
            line-height: 1.1;
            font-weight: 700;
            color: var(--dora-blue);
            width: 450px; /* 配合大字體稍微增加寬度 */
            max-width: 100%;
            margin: 0 auto;
            text-shadow: 3px 3px 0px rgba(255,255,255,0.8);
        }

        .digit-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            width: 100%;
            text-align: right;
            padding-right: 10px;
        }

        .operator-row {
            display: grid;
            grid-template-columns: 1fr repeat(3, 1fr); 
            width: 100%;
            padding-right: 10px;
        }
        
        .operator-sign {
            color: var(--dora-red);
            text-align: left; 
            padding-left: 10px;
        }
        
        #num-top-container, #num-bottom-container {
            grid-column: 2 / span 3;
            display: flex;
            justify-content: flex-end;
        }

        .math-digit {
            font-family: 'Roboto Mono', monospace;
            width: 1em; 
            text-align: center;
        }

        .answer-line {
            width: 100%;
            height: 8px;
            background-color: var(--dora-blue);
            margin: 5px 0;
            border-radius: 4px;
        }

        /* 答案框容器 */
        #answer-input-container {
            display: flex;
            justify-content: flex-end;
            width: 100%;
            padding-right: 10px;
            margin-top: 5px;
            min-height: 7.5rem;
            color: var(--dora-red);
        }

        /* 答案空格樣式 */
        .answer-digit-box {
            width: 1em;
            height: 1.2em;
            margin-left: 0.1em;
            background-color: var(--dora-white);
            border: 5px solid var(--dora-blue);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 7rem; /* 加大答案框數字字體 */
            font-weight: 700;
            cursor: pointer;
            transition: all 0.1s;
            font-family: 'Roboto Mono', monospace;
        }
        
        /* 突出顯示選中的答案空格 */
        .answer-digit-box.active {
            border-color: var(--dora-yellow);
            box-shadow: 0 0 15px var(--dora-yellow);
        }

        /* === 按鈕樣式 (最大化) === */
        .bubble-btn {
            transition: all 0.1s ease;
            border-bottom-width: 6px;
        }
        .bubble-btn:active {
            transform: translateY(4px);
            border-bottom-width: 2px;
            box-shadow: none !important;
        }
        
        .key-style {
            background-color: var(--dora-white);
            color: var(--dora-blue);
            border: 3px solid var(--dora-blue);
            box-shadow: 0 5px 0 #B3E5FC;
            border-radius: 15px; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            height: 100%;
        }

        .num-key-large {
            font-size: 6.5rem; 
            padding: 40px 0;
        }

        .btn-dora-blue {
            background-color: var(--dora-blue);
            color: white;
            border-color: #008CBF;
            box-shadow: 0 4px 0 #008CBF;
        }
        .btn-dora-blue:hover { background-color: #29B6F6; }

        .btn-dora-yellow {
            background-color: var(--dora-yellow);
            color: #A85F00;
            border-color: #EBCB00;
            box-shadow: 0 6px 0 #EBCB00;
            text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
        }
        .btn-dora-yellow:hover { background-color: #FFF176; }
        
    </style>
</head>
<!-- 修正 body class: 使用 min-h-[100dvh] 確保高度可延伸，移除 overflow-hidden -->
<body class="min-h-[100dvh] flex flex-col items-center">

    <div id="menu-screen" class="w-full max-w-md p-6 text-center transition-all duration-300">
        <div class="mb-10 relative">
            <h1 class="text-5xl font-bold text-[--dora-blue] drop-shadow-[0_3px_0_#fff]">
                <i class="fas fa-bell text-[--dora-yellow] drop-shadow-[0_2px_0_#A85F00] animate-bounce"></i> 
                數學大冒險
            </h1>
            <p class="text-[--dora-blue] mt-4 text-xl font-bold">和哆啦A夢一起練習直式加法！</p>
        </div>
        
        <div class="space-y-6 px-4">
            <button onclick="startGame(1)" class="w-full btn-dora-blue bubble-btn text-3xl py-5 rounded-full font-bold relative overflow-hidden group">
                <span class="relative z-10">1 位數 + 1 位數</span>
                <i class="fas fa-rocket absolute right-6 top-1/2 -translate-y-1/2 opacity-50 group-hover:opacity-100 transition-opacity"></i>
            </button>
            <button onclick="startGame(2)" class="w-full btn-dora-blue bubble-btn text-3xl py-5 rounded-full font-bold relative overflow-hidden group">
                <span class="relative z-10">1 位數 + 2 位數</span>
                <i class="fas fa-star absolute right-6 top-1/2 -translate-y-1/2 opacity-50 group-hover:opacity-100 transition-opacity"></i>
            </button>
            <button onclick="startGame(3)" class="w-full btn-dora-blue bubble-btn text-3xl py-5 rounded-full font-bold relative overflow-hidden group">
                <span class="relative z-10">2 位數 + 2 位數</span>
                <i class="fas fa-crown absolute right-6 top-1/2 -translate-y-1/2 opacity-50 group-hover:opacity-100 transition-opacity"></i>
            </button>
        </div>
    </div>

    <!-- 遊戲畫面：確保可以垂直伸展 -->
    <div id="game-screen" class="hidden w-full p-4 flex-col h-full justify-between">
        
        <!-- 頂部資訊欄 (全寬) -->
        <div class="flex justify-between items-center mt-4 mb-2 px-2 max-w-7xl mx-auto w-full">
            <button onclick="backToMenu()" class="text-[--dora-blue] bg-white hover:bg-blue-50 text-2xl w-14 h-14 rounded-full shadow-[0_4px_0_#B3E5FC] border-2 border-[--dora-blue] bubble-btn flex items-center justify-center">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="flex items-center bg-[--dora-yellow] px-6 py-3 rounded-full shadow-[0_4px_0_#EBCB00] border-2 border-[#EBCB00]">
                <i class="fas fa-bell text-[#A85F00] mr-2 text-2xl"></i>
                <span class="text-2xl font-bold text-[#A85F00]">得分: <span id="score">0</span></span>
            </div>
        </div>

        <!-- 主遊戲內容區塊 (限制 max-w-7xl 並居中) -->
        <div class="flex-grow flex flex-col sm:flex-row items-stretch justify-center gap-4 mb-4 w-full max-w-7xl mx-auto">
            
            <!-- 左側：數字鍵盤 (3x4) -->
            <div class="w-full sm:w-[35%] p-2 grid grid-cols-3 gap-4">
                <!-- 數字 7-9 -->
                <button onclick="inputNum(7)" class="key-style num-key-large bubble-btn">7</button>
                <button onclick="inputNum(8)" class="key-style num-key-large bubble-btn">8</button>
                <button onclick="inputNum(9)" class="key-style num-key-large bubble-btn">9</button>
                <!-- 數字 4-6 -->
                <button onclick="inputNum(4)" class="key-style num-key-large bubble-btn">4</button>
                <button onclick="inputNum(5)" class="key-style num-key-large bubble-btn">5</button>
                <button onclick="inputNum(6)" class="key-style num-key-large bubble-btn">6</button>
                <!-- 數字 1-3 -->
                <button onclick="inputNum(1)" class="key-style num-key-large bubble-btn">1</button>
                <button onclick="inputNum(2)" class="key-style num-key-large bubble-btn">2</button>
                <button onclick="inputNum(3)" class="key-style num-key-large bubble-btn">3</button>
                
                <!-- 數字 0 (佔據 3 個欄位) -->
                <button onclick="inputNum(0)" class="col-span-3 key-style num-key-large bubble-btn">0</button>
            </div>

            <!-- 右側：題目卡片 (佔 2/3 寬度) -->
            <div class="w-full sm:w-[65%] flex items-center justify-center bg-white rounded-[40px] shadow-[0_8px_0_#B3E5FC] border-4 border-[--dora-blue] relative" id="problem-card"> 
                
                <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none" style="background-image: radial-gradient(var(--dora-blue) 2px, transparent 2px); background-size: 20px 20px;"></div>

                <div id="feedback-overlay" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90 hidden z-20 rounded-[36px]"></div>

                <div class="math-column relative z-10 py-8">
                    <!-- 數字 1 -->
                    <div id="num-top-container" class="digit-row">
                        <!-- 數字內容將由 JS 填充 -->
                    </div>
                    
                    <!-- 運算符號 + 數字 2 -->
                    <div class="operator-row">
                        <span class="operator-sign text-[10rem]">+</span> 
                        <div id="num-bottom-container" style="grid-column: 2 / span 3; display: flex; justify-content: flex-end;">
                             <!-- 數字內容將由 JS 填充 -->
                        </div>
                    </div>
                    
                    <div class="answer-line"></div>
                    
                    <!-- 答案輸入區塊 -->
                    <div id="answer-input-container">
                        <!-- 答案空格將由 JS 生成 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 底部：操作按鈕區塊 (全寬，限制 max-w-7xl 並居中) -->
        <div class="grid grid-cols-4 gap-3 mb-4 px-2 pb-safe max-w-7xl mx-auto w-full">
            <!-- 刪除修改 (清除當前位) -->
            <button onclick="clearInput()" class="col-span-1 key-style bubble-btn !bg-red-50 !text-[--dora-red] !border-[--dora-red] shadow-[0_5px_0_#FFCDD2] text-2xl py-3 font-bold">
                <i class="fas fa-backspace mr-1"></i>清除
            </button>
            <!-- 快速跳到下一個空格 -->
            <button onclick="selectNextEmptyBox()" class="col-span-1 key-style bubble-btn !bg-blue-50 !text-[--dora-blue] !border-[--dora-blue] shadow-[0_5px_0_#B3E5FC] text-2xl py-3 font-bold">
                <i class="fas fa-arrow-right mr-1"></i>下一格
            </button>
            <!-- 送出選項 -->
            <button onclick="checkAnswer()" class="col-span-2 btn-dora-yellow bubble-btn text-2xl font-bold rounded-xl shadow-[0_6px_0_#EBCB00] flex items-center justify-center py-3">
                <i class="fas fa-check mr-2"></i>送出答案
            </button>
        </div>
    </div>

    <audio id="sound-correct" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" preload="auto"></audio>
    <audio id="sound-wrong" src="https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3" preload="auto"></audio>

    <script>
        // 遊戲狀態
        let currentLevel = 0;
        let score = 0;
        let currentAnswer = 0;
        let userInputArray = []; 
        let maxDigits = 3; // 保持 3 位用於問題對齊
        let activeBoxIndex = -1; 
        
        // DOM 元素
        const menuScreen = document.getElementById('menu-screen');
        const gameScreen = document.getElementById('game-screen');
        const scoreDisplay = document.getElementById('score');
        const numTopContainer = document.getElementById('num-top-container');
        const numBottomContainer = document.getElementById('num-bottom-container');
        const answerInputContainer = document.getElementById('answer-input-container');
        const feedbackOverlay = document.getElementById('feedback-overlay');
        const soundCorrect = document.getElementById('sound-correct');
        const soundWrong = document.getElementById('sound-wrong');

        const imgCorrectUrl = "https://cdn-icons-png.flaticon.com/512/7518/7518748.png"; 
        const imgWrongUrl = "https://cdn-icons-png.flaticon.com/512/7518/7518694.png";    

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function startGame(level) {
            currentLevel = level;
            score = 0;
            updateScore();
            menuScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            gameScreen.classList.add('flex');
            
            try {
                soundCorrect.load();
                soundWrong.load();
            } catch (e) {
                console.log("Audio load failed:", e);
            }

            nextQuestion();
        }

        function backToMenu() {
            gameScreen.classList.add('hidden');
            gameScreen.classList.remove('flex');
            menuScreen.classList.remove('hidden');
            feedbackOverlay.classList.add('hidden');
        }

        function updateScore() {
            scoreDisplay.textContent = score;
        }

        /**
         * 格式化數字並填充到容器中，確保數字在三位空間內靠右對齊
         * @param {number} num 要顯示的數字
         * @param {HTMLElement} container 顯示數字的容器
         */
        function renderNumber(num, container) {
            const numStr = String(num);
            // 使用固定的 maxDigits (3) 進行填充，確保對齊
            const paddedStr = numStr.padStart(maxDigits, ' '); 
            
            container.innerHTML = '';
            for (const digit of paddedStr) {
                const span = document.createElement('span');
                span.className = 'math-digit';
                span.textContent = digit === ' ' ? '\xa0' : digit; // 使用 &nbsp; 代替空格
                container.appendChild(span);
            }
        }

        function nextQuestion() {
            let num1, num2;

            if (currentLevel === 1) {
                num1 = getRandomInt(1, 9);
                num2 = getRandomInt(1, 9);
            } else if (currentLevel === 2) {
                const single = getRandomInt(1, 9);
                const double = getRandomInt(10, 99);
                if (Math.random() > 0.5) { num1 = double; num2 = single; } 
                else { num1 = single; num2 = double; }
            } else {
                num1 = getRandomInt(10, 99);
                num2 = getRandomInt(10, 99);
            }

            currentAnswer = num1 + num2;
            
            // --- 修正核心邏輯：動態設定答案框數量 ---
            const answerSlots = String(currentAnswer).length;
            
            // 重新渲染題目數字，確保使用 maxDigits=3 進行精確對齊
            renderNumber(num1, numTopContainer);
            renderNumber(num2, numBottomContainer);

            // 使用答案所需的精確位數來初始化輸入陣列
            userInputArray = Array(answerSlots).fill(''); 
            
            // 生成答案空格
            generateAnswerBoxes();
            
            // 預設選擇個位數 (陣列的最後一個元素)
            activeBoxIndex = userInputArray.length - 1;
            updateActiveBox();
        }

        function generateAnswerBoxes() {
            answerInputContainer.innerHTML = ''; 
            
            // 根據 userInputArray 的實際長度生成答案空格
            for (let i = 0; i < userInputArray.length; i++) {
                const box = document.createElement('div');
                box.className = 'answer-digit-box placeholder';
                box.dataset.index = i;
                box.innerHTML = '<span>?</span>';
                box.onclick = () => setActiveBox(i);
                answerInputContainer.appendChild(box);
            }
        }
        
        function updateActiveBox() {
            const boxes = answerInputContainer.querySelectorAll('.answer-digit-box');
            boxes.forEach((box, index) => {
                box.classList.remove('active');
                if (index === activeBoxIndex) {
                    box.classList.add('active');
                }
            });
        }
        
        function updateDisplay() {
            const boxes = answerInputContainer.querySelectorAll('.answer-digit-box');
            boxes.forEach((box, index) => {
                const digit = userInputArray[index];
                const span = box.querySelector('span');
                if (digit === '') {
                    span.textContent = '?';
                    box.classList.add('placeholder');
                } else {
                    span.textContent = digit;
                    box.classList.remove('placeholder');
                }
            });
        }

        function setActiveBox(index) {
            if (index >= 0 && index < userInputArray.length) {
                activeBoxIndex = index;
                updateActiveBox();
            }
        }

        function getNextEmptyIndex(startIndex) {
            for (let i = startIndex; i < userInputArray.length; i++) {
                if (userInputArray[i] === '') {
                    return i;
                }
            }
            for (let i = 0; i < startIndex; i++) {
                if (userInputArray[i] === '') {
                    return i;
                }
            }
            return -1;
        }

        function selectNextEmptyBox() {
            const nextIndex = getNextEmptyIndex(activeBoxIndex + 1);
            
            if (nextIndex !== -1) {
                setActiveBox(nextIndex);
            } else {
                updateActiveBox();
            }
        }

        function inputNum(num) {
            if (activeBoxIndex !== -1) {
                userInputArray[activeBoxIndex] = String(num);
                updateDisplay();
                
                const nextEmptyIndex = getNextEmptyIndex(activeBoxIndex + 1);
                
                if (nextEmptyIndex !== -1) {
                    setActiveBox(nextEmptyIndex);
                } else {
                    setActiveBox(userInputArray.length - 1);
                }
            }
        }

        function clearInput() {
            if (activeBoxIndex !== -1) {
                if (userInputArray[activeBoxIndex] !== '') {
                    userInputArray[activeBoxIndex] = '';
                    updateDisplay();
                } 
                else if (activeBoxIndex > 0) {
                    setActiveBox(activeBoxIndex - 1);
                    userInputArray[activeBoxIndex] = '';
                    updateDisplay();
                }
            }
        }

        function checkAnswer() {
            const fullUserInput = userInputArray.join('');
            
            if (userInputArray.includes('')) {
                alert('請將所有空格填寫完整！');
                return;
            }

            const userInt = Number(fullUserInput); 
            const correctInt = Number(currentAnswer); 
            
            if (userInt === correctInt) {
                showFeedback(true);
                score += 10;
                updateScore();
                setTimeout(nextQuestion, 1200);
            } else {
                showFeedback(false);
                // 錯誤時，清空陣列並重置為正確的長度
                userInputArray = Array(userInputArray.length).fill(''); 
                updateDisplay();
                setActiveBox(userInputArray.length - 1); 
            }
        }

        function playSound(audioElement) {
            try {
                audioElement.pause();
                audioElement.currentTime = 0;
                audioElement.play();
            } catch (e) {
                console.log("Audio play failed (user gesture required):", e);
            }
        }

        function showFeedback(isCorrect) {
            
            feedbackOverlay.classList.remove('hidden');
            feedbackOverlay.innerHTML = '';

            const feedbackWrapper = document.createElement('div');
            feedbackWrapper.className = "flex flex-col items-center justify-center space-y-4"; // 垂直堆疊
            
            const feedbackImg = document.createElement('img');
            feedbackImg.className = "w-48 h-48 drop-shadow-2xl";

            if (isCorrect) {
                feedbackOverlay.className = "absolute inset-0 flex items-center justify-center bg-[#E0F7FF] bg-opacity-95 z-20 rounded-[36px]";
                feedbackImg.src = imgCorrectUrl;
                feedbackImg.classList.add('animate-bounce');
                
                feedbackWrapper.appendChild(feedbackImg);
                playSound(soundCorrect); 
            } else {
                feedbackOverlay.className = "absolute inset-0 flex items-center justify-center bg-[#FFEBEE] bg-opacity-95 z-20 rounded-[36px]";
                feedbackImg.src = imgWrongUrl;
                feedbackImg.classList.add('animate-pulse');
                
                // --- 新增：答錯時顯示 "再試一次" 文字 ---
                const feedbackText = document.createElement('div');
                feedbackText.className = "text-5xl font-extrabold text-[--dora-red] drop-shadow-[0_2px_0_#fff] animate-bounce";
                feedbackText.textContent = "再試一次";

                feedbackWrapper.appendChild(feedbackImg);
                feedbackWrapper.appendChild(feedbackText);
                
                playSound(soundWrong);
            }

            feedbackOverlay.appendChild(feedbackWrapper); // 將圖片/文字組成的 Wrapper 放入 Overlay

            setTimeout(() => {
                feedbackOverlay.classList.add('hidden');
                feedbackOverlay.innerHTML = '';
            }, 1200);
        }
        
        // 確保剛載入頁面時，gameScreen是隱藏的
        if (gameScreen && gameScreen.classList.contains('flex')) {
            gameScreen.classList.remove('flex');
            gameScreen.classList.add('hidden');
        }
    </script>
</body>
</html>